<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlowStep Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reactflow@11.11.4/dist/style.css" />
    <style>
      html, body, #root {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .react-flow__node {
        cursor: pointer;
      }
      .react-flow__edge-path {
        stroke-width: 3;
      }
      .react-flow__edge.selected .react-flow__edge-path {
        stroke: #6366f1;
        stroke-width: 4;
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      @keyframes fade-in-up {
        from { opacity: 0; transform: translate(-50%, 10px); }
        to { opacity: 1; transform: translate(-50%, 0); }
      }
      .animate-toast {
        animation: fade-in-up 0.3s ease-out forwards;
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom": "https://esm.sh/react-dom@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "react/jsx-runtime": "https://esm.sh/react@18.3.1/jsx-runtime",
    "reactflow": "https://esm.sh/reactflow@11.11.4?external=react,react-dom"
  }
}
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React, { useCallback, useMemo, useState } from 'react';
      import ReactDOM from 'react-dom/client';
      import ReactFlow, {
        Background,
        Controls,
        MiniMap,
        MarkerType,
        Handle,
        Position,
        ReactFlowProvider,
        useNodesState,
        useEdgesState
      } from 'reactflow';

      const FLOWSTEP_DATA = {"version":1,"meta":{"name":"STT-TTS Communication Assistant Support Flow","format":"reactflow","notes":"Snapshot: 25.12.2025, 11:54:46"},"nodes":[{"id":"app_start","type":"custom","position":{"x":405,"y":0},"data":{"label":"App Start & Initialization","details":["Load AI models (Whisper & Piper)","Initialize the user interface","Start background workers for audio processing"]}},{"id":"device_check","type":"custom","position":{"x":405,"y":195},"data":{"label":"Audio Device Check","details":["Detect 'Hi-Fi Cable' or default microphone","Verify sample rate","Configure the WASAPI interface"]}},{"id":"err_device","type":"custom","position":{"x":810,"y":195},"data":{"label":"Hardware Error","details":["Input device not found or in use","Driver conflict with WASAPI loopback","Fallback to default microphone failed"]}},{"id":"audio_capture","type":"custom","position":{"x":345,"y":405},"data":{"label":"Audio Monitoring (Active)","details":["Continuously capture the audio stream","Convert the format for AI processing","Buffer raw data in memory"]}},{"id":"vad_analysis","type":"custom","position":{"x":405,"y":600},"data":{"label":"Voice Activity Detection (VAD)","details":["Differentiate speech from background noise","Detect pauses in conversation","Assemble audio segments when voice is detected"]}},{"id":"stt_transcription","type":"custom","position":{"x":405,"y":800},"data":{"label":"AI Speech-to-Text","details":["Convert audio segments into written text","Filter noise and reverb","Display the result in the transcript view"]}},{"id":"err_stt","type":"custom","position":{"x":800,"y":800},"data":{"label":"Transcription Error","details":["Audio quality too low for recognition","GPU/CPU overload during inference","AI model returns no plausible output"]}},{"id":"tts_trigger","type":"custom","position":{"x":405,"y":1005},"data":{"label":"Text-to-Speech Request","details":["Enter free text or select a template","Optimize pronunciation (text adjustments)","Forward the request to the synthesis engine"]}},{"id":"piper_synth","type":"custom","position":{"x":405,"y":1200},"data":{"label":"Speech Synthesis","details":["Generate a temporary audio file","Apply the selected voice (e.g., Thorsten)","Output via the virtual audio cable to the other party"]}},{"id":"err_tts","type":"custom","position":{"x":800,"y":1193.5},"data":{"label":"Synthesis Error","details":["Speech engine (Piper) not reachable","Pronunciation/voice models missing from the directory","Access error when writing the temporary audio file"]}},{"id":"node_1766663281987","type":"custom","position":{"x":405,"y":-180},"data":{"label":"Explaining the Example","details":["This ReactFlow was generated by an AI based on the application’s source code and represents a dashboard for TTS ↔ STT communication between a deaf support agent and a customer on the phone."]}}],"edges":[{"id":"e1","source":"app_start","target":"device_check","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"},{"id":"e2","source":"device_check","target":"audio_capture","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"},{"id":"e_dev_err","source":"device_check","target":"err_device","sourceHandle":"right-source","targetHandle":"left-target","type":"smoothstep","label":"Hardware not ready"},{"id":"e3","source":"audio_capture","target":"vad_analysis","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"},{"id":"e4","source":"vad_analysis","target":"stt_transcription","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"},{"id":"e_stt_err","source":"stt_transcription","target":"err_stt","sourceHandle":"right-source","targetHandle":"left-target","type":"smoothstep","label":"Recognition failed"},{"id":"e5","source":"stt_transcription","target":"tts_trigger","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"},{"id":"e6","source":"tts_trigger","target":"piper_synth","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"},{"id":"e_tts_err","source":"piper_synth","target":"err_tts","sourceHandle":"right-source","targetHandle":"left-target","type":"smoothstep","label":"Engine error"},{"id":"e_loopback","source":"piper_synth","target":"audio_capture","sourceHandle":"bottom-source","targetHandle":"left-target","type":"smoothstep","label":"Ready for next input"},{"id":"reactflow__edge-node_1766663281987bottom-source-app_starttop-target","source":"node_1766663281987","target":"app_start","sourceHandle":"bottom-source","targetHandle":"top-target","type":"smoothstep"}]};
      const THEME_COLOR = "#6366f1";
      const GRID_STEP = 15;

      const CustomNode = ({ data, selected }) => {
        const isHighlighted = data.isHighlighted;
        const isVisible = data.isVisible !== false;

        if (!isVisible) return React.createElement('div', { className: 'opacity-0 pointer-events-none' });

        const activeColor = 'var(--accent-color, #6366f1)';
        const handleClass = 'w-3 h-3 border-2 transition-colors duration-200';

        const DualHandle = ({ pos, idPrefix }) => (
          React.createElement(React.Fragment, null,
            React.createElement(Handle, {
              id: idPrefix + '-target',
              type: 'target',
              position: pos,
              className: handleClass + ' z-10',
              style: {
                visibility: 'visible',
                backgroundColor: isHighlighted ? activeColor : '#cbd5e1',
                borderColor: '#fff',
                ...(pos === Position.Top || pos === Position.Bottom ? { left: '50%', transform: 'translateX(-50%)' } : { top: '50%', transform: 'translateY(-50%)' }),
                ...(pos === Position.Top ? { top: '-7px' } : {}),
                ...(pos === Position.Bottom ? { bottom: '-7px' } : {}),
                ...(pos === Position.Left ? { left: '-7px' } : {}),
                ...(pos === Position.Right ? { right: '-7px' } : {})
              }
            }),
            React.createElement(Handle, {
              id: idPrefix + '-source',
              type: 'source',
              position: pos,
              className: handleClass + ' opacity-0 hover:opacity-100 z-20',
              style: {
                backgroundColor: isHighlighted ? activeColor : '#cbd5e1',
                borderColor: '#fff',
                ...(pos === Position.Top || pos === Position.Bottom ? { left: '50%', transform: 'translateX(-50%)' } : { top: '50%', transform: 'translateY(-50%)' }),
                ...(pos === Position.Top ? { top: '-7px' } : {}),
                ...(pos === Position.Bottom ? { bottom: '-7px' } : {}),
                ...(pos === Position.Left ? { left: '-7px' } : {}),
                ...(pos === Position.Right ? { right: '-7px' } : {})
              }
            })
          )
        );

        const baseClass = 'group relative px-4 py-3 rounded-xl border-2 transition-all duration-300 shadow-lg w-64';
        const stateClass = (isHighlighted ? 'bg-white ring-4' : 'bg-white border-slate-200') + (selected ? ' ring-2' : '');

        return (
          React.createElement('div', {
            className: baseClass + ' ' + stateClass,
            style: {
              borderColor: isHighlighted ? activeColor : (selected ? activeColor : undefined),
              '--tw-ring-color': isHighlighted ? activeColor + '33' : activeColor + '1a'
            }
          },
            React.createElement(DualHandle, { pos: Position.Top, idPrefix: 'top' }),
            React.createElement(DualHandle, { pos: Position.Left, idPrefix: 'left' }),
            React.createElement(DualHandle, { pos: Position.Right, idPrefix: 'right' }),
            React.createElement(DualHandle, { pos: Position.Bottom, idPrefix: 'bottom' }),
            React.createElement('div', { className: 'flex flex-col relative' },
              React.createElement('span', {
                className: 'text-sm font-bold mb-1 break-words flex-grow',
                style: { color: isHighlighted ? activeColor : '#1e293b' }
              }, data.label),
              data.details && data.details.length > 0 && (
                React.createElement('div', { className: 'mt-2 pt-2 border-t border-slate-100 min-h-[10px]' },
                  React.createElement('ul', { className: 'list-disc pl-4 space-y-1' },
                    data.details.map((detail, idx) => (
                      React.createElement('li', {
                        key: idx,
                        className: 'text-[10px] leading-tight text-slate-500 font-medium'
                      }, detail)
                    ))
                  )
                )
              )
            )
          )
        );
      };

      const nodeTypes = { custom: CustomNode };

      const AppContent = () => {
        const [nodes, setNodes, onNodesChange] = useNodesState(FLOWSTEP_DATA.nodes);
        const [edges, setEdges, onEdgesChange] = useEdgesState(FLOWSTEP_DATA.edges);
        const [mode, setMode] = useState('READER');
        const [visibleNodeIds, setVisibleNodeIds] = useState(new Set());
        const [activeNodeId, setActiveNodeId] = useState(null);

        const selectedNode = useMemo(() => nodes.find(n => n.selected), [nodes]);

        const initializeSequence = useCallback(() => {
          const firstNode = nodes.find(n => !edges.some(e => e.target === n.id)) || nodes[0];
          if (firstNode) {
            setVisibleNodeIds(new Set([firstNode.id]));
            setActiveNodeId(firstNode.id);
          }
        }, [nodes, edges]);

        const handleModeChange = useCallback((nextMode) => {
          setMode(nextMode);
          if (nextMode === 'SEQUENCE') {
            initializeSequence();
          } else {
            setVisibleNodeIds(new Set());
            setActiveNodeId(null);
          }
        }, [initializeSequence]);

        const advanceSequence = useCallback(() => {
          const nextNodeIds = new Set(Array.from(visibleNodeIds));
          let added = false;

          edges.forEach(edge => {
            if (visibleNodeIds.has(edge.source) && !nextNodeIds.has(edge.target)) {
              nextNodeIds.add(edge.target);
              added = true;
            }
          });

          if (added) setVisibleNodeIds(nextNodeIds);
        }, [visibleNodeIds, edges]);

        const onNodeClick = useCallback((_event, node) => {
          if (mode === 'SEQUENCE') {
            const targets = edges.filter(e => e.source === node.id).map(e => e.target);
            if (targets.length > 0) {
              setVisibleNodeIds(prev => {
                const next = new Set(prev);
                targets.forEach(t => next.add(t));
                return next;
              });
              setActiveNodeId(node.id);
            }
          }
        }, [mode, edges]);

        const displayNodes = useMemo(() => {
          return nodes.map(node => {
            const isVisible = mode === 'READER' || visibleNodeIds.has(node.id);
            const isHighlighted = mode === 'SEQUENCE' && activeNodeId === node.id;
            return {
              ...node,
              draggable: false,
              data: {
                ...node.data,
                isVisible,
                isHighlighted
              }
            };
          });
        }, [nodes, mode, visibleNodeIds, activeNodeId]);

        const displayEdges = useMemo(() => {
          return edges.map(edge => {
            const sourceVisible = mode === 'READER' || visibleNodeIds.has(edge.source);
            const targetVisible = mode === 'READER' || visibleNodeIds.has(edge.target);
            const isVisible = sourceVisible && targetVisible;

            return {
              ...edge,
              hidden: !isVisible,
              animated: mode === 'SEQUENCE' && isVisible,
              markerEnd: { type: MarkerType.ArrowClosed, color: isVisible ? THEME_COLOR : '#cbd5e1' },
              style: { stroke: isVisible ? THEME_COLOR : '#cbd5e1', strokeWidth: 2 }
            };
          });
        }, [edges, mode, visibleNodeIds]);

        const canGoNext = useMemo(() => {
          if (mode !== 'SEQUENCE') return false;
          return edges.some(e => {
            const sourceVisible = visibleNodeIds.has(e.source);
            const targetVisible = visibleNodeIds.has(e.target);
            return sourceVisible && !targetVisible;
          });
        }, [mode, edges, visibleNodeIds]);

        return (
          React.createElement('div', {
            className: 'w-full h-full bg-slate-50 relative overflow-hidden',
            style: { '--accent-color': THEME_COLOR }
          },
            React.createElement('div', { className: 'absolute top-6 left-6 z-50 flex flex-col gap-4 pointer-events-none' },
              React.createElement('div', { className: 'bg-white/90 backdrop-blur-md shadow-xl border border-slate-200 rounded-2xl p-1.5 flex gap-1 pointer-events-auto' },
                React.createElement('button', {
                  onClick: () => handleModeChange('READER'),
                  className: 'flex items-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 text-sm font-semibold ' +
                    (mode === 'READER' ? 'text-white shadow-lg' : 'text-slate-600 hover:bg-slate-100'),
                  style: mode === 'READER' ? { backgroundColor: THEME_COLOR } : {}
                }, 'Reader'),
                React.createElement('button', {
                  onClick: () => handleModeChange('SEQUENCE'),
                  className: 'flex items-center gap-2 px-4 py-2 rounded-xl transition-all duration-200 text-sm font-semibold ' +
                    (mode === 'SEQUENCE' ? 'text-white shadow-lg' : 'text-slate-600 hover:bg-slate-100'),
                  style: mode === 'SEQUENCE' ? { backgroundColor: THEME_COLOR } : {}
                }, 'Sequence')
              ),
              mode === 'SEQUENCE' && (
                React.createElement('div', {
                  className: 'bg-white border shadow-lg rounded-2xl p-1.5 flex gap-1 pointer-events-auto items-start animate-in slide-in-from-left-4',
                  style: { borderColor: THEME_COLOR + '40' }
                },
                  React.createElement('button', {
                    onClick: initializeSequence,
                    className: 'p-2.5 rounded-xl transition-all hover:bg-slate-50',
                    style: { color: THEME_COLOR },
                    title: 'Reset Flow'
                  }, 'Reset'),
                  React.createElement('button', {
                    onClick: advanceSequence,
                    disabled: !canGoNext,
                    className: 'flex items-center gap-2 px-5 py-2.5 rounded-xl transition-all font-bold text-sm text-white ' +
                      (canGoNext ? 'shadow-md active:scale-95' : 'opacity-40 cursor-not-allowed'),
                    style: canGoNext ? { backgroundColor: THEME_COLOR } : { backgroundColor: '#cbd5e1' }
                  }, 'Next')
                )
              )
            ),
            React.createElement(ReactFlow, {
              nodes: displayNodes,
              edges: displayEdges,
              onNodesChange,
              onEdgesChange,
              onNodeClick,
              nodeTypes,
              fitView: true,
              snapToGrid: true,
              snapGrid: [GRID_STEP, GRID_STEP],
              nodesDraggable: false,
              nodesConnectable: false,
              elementsSelectable: true,
              deleteKeyCode: null
            },
              React.createElement(Background, { color: '#cbd5e1', gap: 20 }),
              React.createElement(Controls, null),
              React.createElement(MiniMap, {
                nodeColor: (n) => (n.data && n.data.isHighlighted ? THEME_COLOR : '#fff'),
                maskColor: 'rgba(241, 245, 249, 0.6)'
              })
            ),
            React.createElement('div', {
              className: 'absolute top-6 right-6 z-50 w-72 bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl border border-slate-200 overflow-hidden flex flex-col max-h-[90vh]'
            },
              React.createElement('div', { className: 'p-4 border-b border-slate-100 bg-slate-50/50' },
                React.createElement('h3', { className: 'text-slate-900 font-bold text-base' }, 'Node Details')
              ),
              React.createElement('div', { className: 'flex-grow overflow-y-auto p-4 space-y-4' },
                selectedNode ? (
                  React.createElement('div', { className: 'space-y-3' },
                    React.createElement('div', { className: 'text-sm font-bold text-slate-900' }, selectedNode.data.label),
                    selectedNode.data.details && selectedNode.data.details.length > 0 ? (
                      React.createElement('ul', { className: 'list-disc pl-5 space-y-1 text-xs text-slate-600' },
                        selectedNode.data.details.map((detail, idx) => (
                          React.createElement('li', { key: idx }, detail)
                        ))
                      )
                    ) : (
                      React.createElement('p', { className: 'text-xs text-slate-400' }, 'No details for this node.')
                    )
                  )
                ) : (
                  React.createElement('p', { className: 'text-xs text-slate-400' }, 'Select a node to view details.')
                )
              )
            ),
            mode === 'SEQUENCE' && (
              React.createElement('div', { className: 'absolute bottom-10 left-1/2 -translate-x-1/2 z-50 pointer-events-none' },
                React.createElement('div', {
                  className: 'bg-white/90 backdrop-blur px-6 py-3 rounded-full shadow-2xl border flex items-center gap-4 animate-bounce',
                  style: { borderColor: THEME_COLOR + '40' }
                },
                  React.createElement('span', { className: 'font-bold text-sm', style: { color: THEME_COLOR } },
                    canGoNext ? "Click a node or 'Next' to reveal" : 'Flow complete!'
                  )
                )
              )
            )
          )
        );
      };

      const App = () => (
        React.createElement(ReactFlowProvider, null, React.createElement(AppContent, null))
      );

      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(React.createElement(React.StrictMode, null, React.createElement(App, null)));
    </script>
  </body>
</html>